rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNÃ‡Ã•ES DE SEGURANÃ‡A
    // ============================================
    
    // Verifica se estÃ¡ autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica se Ã© o dono do documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Verifica se Ã© admin (role admin ou superAdmin)
    function isAdmin() {
       let docPath = /databases/$(database)/documents/professionals/$(request.auth.uid);
       return isAuthenticated() && exists(docPath) && (get(docPath).data.role == 'admin' || get(docPath).data.superAdmin == true);
    }
    
    // Valida tamanho de string (previne spam/overflow)
    function isValidString(field, maxLen) {
      return field is string && field.size() <= maxLen && field.size() > 0;
    }
    
    // Valida email bÃ¡sico
    function isValidEmail(email) {
      return email is string && email.matches('.*@.*[.].*') && email.size() <= 254;
    }
    
    // Valida data ISO
    function isValidISODate(dateStr) {
      return dateStr is string && dateStr.size() >= 10 && dateStr.size() <= 30;
    }
    
    // Rate limiting bÃ¡sico (previne criaÃ§Ã£o em massa)
    function isRecentlyCreated() {
      return request.time < resource.data.createdAt + duration.value(1, 's');
    }

    // ============================================
    // REGRA GLOBAL DE BLOQUEIO (DEFAULT DENY)
    // ============================================
    match /{document=**} {
      allow read, write: if false; 
    }

    // ============================================
    // PROFISSIONAIS
    // ============================================
    match /professionals/{userId} {
      // Leitura pÃºblica (perfil visÃ­vel para clientes)
      allow read: if true;
      
      // CriaÃ§Ã£o: apenas autenticado e criando prÃ³prio perfil
      allow create: if isOwner(userId) 
        && request.resource.data.keys().hasAll(['name', 'email'])
        && isValidString(request.resource.data.name, 100)
        && isValidEmail(request.resource.data.email);
      
      // Update: apenas owner ou admin
      allow update: if (isOwner(userId) || isAdmin())
        && (!('role' in request.resource.data) || request.resource.data.role == resource.data.role || isAdmin())
        && (!('superAdmin' in request.resource.data) || isAdmin());
      
      // Delete: apenas admin
      allow delete: if isAdmin();

      // SERVIÃ‡OS
      match /services/{serviceId} {
        allow read: if true;
        
        allow create: if (isOwner(userId) || isAdmin())
          && request.resource.data.keys().hasAll(['name', 'price', 'duration'])
          && isValidString(request.resource.data.name, 100)
          && request.resource.data.price is number
          && request.resource.data.price >= 0
          && request.resource.data.price <= 10000
          && request.resource.data.duration is number
          && request.resource.data.duration >= 5
          && request.resource.data.duration <= 480;
          
        allow update: if (isOwner(userId) || isAdmin())
          && request.resource.data.price >= 0
          && request.resource.data.price <= 10000;
          
        allow delete: if isOwner(userId) || isAdmin();
      }
      
      // MARCAÃ‡Ã•ES (BOOKINGS)
      match /bookings/{bookingId} {
        // CriaÃ§Ã£o: validaÃ§Ã£o rigorosa
        allow create: if true
          && request.resource.data.keys().hasAll(['date', 'serviceId', 'clientName', 'status'])
          && isValidISODate(request.resource.data.date)
          && isValidString(request.resource.data.serviceId, 50)
          && isValidString(request.resource.data.clientName, 100)
          && request.resource.data.status == 'confirmed'
          && (!('clientEmail' in request.resource.data) || isValidEmail(request.resource.data.clientEmail))
          && (!('clientPhone' in request.resource.data) || request.resource.data.clientPhone.size() <= 20);
        
        // Leitura: pÃºblica (necessÃ¡ria para verificar disponibilidade)
        // NOTA: Em produÃ§Ã£o crÃ­tica, mover para Cloud Function
        allow read: if true;
        
        // Update/Delete: apenas owner ou admin
        allow update: if isOwner(userId) || isAdmin();
        allow delete: if isOwner(userId) || isAdmin();
      }

      // STAFF
      match /staff/{staffId} {
        allow read: if true;
        
        // CriaÃ§Ã£o: apenas owner ou admin
        allow create: if (isOwner(userId) || isAdmin())
          && request.resource.data.keys().hasAll(['name', 'email'])
          && isValidString(request.resource.data.name, 100)
          && isValidEmail(request.resource.data.email);
        
        // Update: owner, admin, ou prÃ³prio staff
        allow update: if isOwner(userId) || isAdmin() 
          || (isAuthenticated() && resource.data.authUserId == request.auth.uid);
        
        // Delete: apenas owner ou admin
        allow delete: if isOwner(userId) || isAdmin();

        // Settings do Staff
        match /settings/{docId} {
          allow read: if true;
          allow write: if isOwner(userId) || isAdmin() 
            || (isAuthenticated() && get(/databases/$(database)/documents/professionals/$(userId)/staff/$(staffId)).data.authUserId == request.auth.uid);
        }

        // Bookings do Staff
        match /bookings/{bookingId} {
          allow create: if true
            && request.resource.data.keys().hasAll(['date', 'serviceId'])
            && isValidISODate(request.resource.data.date)
            && isValidString(request.resource.data.serviceId, 50);
            
          allow read: if true;
          
          allow update, delete: if isOwner(userId) || isAdmin() 
            || (isAuthenticated() && get(/databases/$(database)/documents/professionals/$(userId)/staff/$(staffId)).data.authUserId == request.auth.uid);
        }
      }
      
      // SETTINGS (HorÃ¡rios)
      match /settings/{document=**} {
        allow read: if true;
        allow write: if isOwner(userId) || isAdmin();
      }

      // â­ REVIEWS (AvaliaÃ§Ãµes)
      match /reviews/{reviewId} {
        // Leitura: pÃºblica (visÃ­vel para todos)
        allow read: if true;
        
        // CriaÃ§Ã£o: utilizador autenticado pode criar avaliaÃ§Ã£o
        allow create: if isAuthenticated()
          && request.resource.data.keys().hasAll(['bookingId', 'rating', 'clientId'])
          && request.resource.data.rating is number
          && request.resource.data.rating >= 1
          && request.resource.data.rating <= 5
          && isValidString(request.resource.data.clientName, 100);
        
        // Update: apenas owner pode responder (professionalResponse)
        allow update: if (isOwner(userId) || isAdmin())
          && request.resource.data.rating == resource.data.rating
          && request.resource.data.clientId == resource.data.clientId;
        
        // Delete: apenas owner ou admin (casos de spam/abuso)
        allow delete: if isOwner(userId) || isAdmin();
      }
    }
    
    // ============================================
    // CLIENTES
    // ============================================
    match /clients/{clientId} {
      // CriaÃ§Ã£o: autenticado e criando prÃ³prio documento
      allow create: if isOwner(clientId)
        && request.resource.data.keys().hasAll(['name', 'email'])
        && isValidString(request.resource.data.name, 100)
        && isValidEmail(request.resource.data.email);
      
      // Leitura/Update: apenas prÃ³prio cliente
      allow read, update: if isOwner(clientId);
      
      // Delete: nÃ£o permitido
      allow delete: if false;
    }

    // ============================================
    // STAFF LOOKUP (Mapeamento de login)
    // ============================================
    match /staff_lookup/{authUid} {
      // Leitura: apenas autenticado
      allow read: if isAuthenticated();
      
      // CriaÃ§Ã£o: autenticado (para setup inicial)
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['ownerId', 'staffId'])
        && isValidString(request.resource.data.ownerId, 50)
        && isValidString(request.resource.data.staffId, 50);
      
      // Update/Delete: apenas pelo owner do estabelecimento ou prÃ³prio
      allow update, delete: if isAuthenticated() 
        && (resource.data.ownerId == request.auth.uid || request.auth.uid == authUid);
    }

    // ============================================
    // ðŸ›¡ï¸ AUDIT LOGS - SEGURANÃ‡A MÃXIMA
    // ============================================
    match /audit_logs/{logId} {
      // ESCRITA: Qualquer utilizador autenticado pode criar logs
      // (necessÃ¡rio para registar eventos de seguranÃ§a)
      // Nota: serverTimestamp() Ã© validado pelo Firestore automaticamente
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['eventType', 'severity'])
        && isValidString(request.resource.data.eventType, 100)
        && request.resource.data.severity in ['info', 'warning', 'error', 'critical'];
      
      // LEITURA: Apenas admins podem ver os logs
      allow read: if isAdmin();
      
      // UPDATE/DELETE: NUNCA PERMITIDO - Logs sÃ£o imutÃ¡veis
      allow update, delete: if false;
    }

    // ============================================
    // ðŸ” SECURITY EVENTS (Rate Limits, Blocks)
    // ============================================
    match /security_events/{eventId} {
      // Apenas admins podem ver eventos de seguranÃ§a
      allow read: if isAdmin();
      
      // Sistema pode criar (via Cloud Functions)
      allow create: if isAuthenticated();
      
      // ImutÃ¡vel
      allow update, delete: if false;
    }

    // ============================================
    // ðŸ“Š ANALYTICS (Dados agregados)
    // ============================================
    match /analytics/{docId} {
      // Leitura: apenas admins
      allow read: if isAdmin();
      
      // Escrita: apenas por Cloud Functions (owner pode atualizar seus prÃ³prios)
      allow write: if isAdmin();
    }
  }
}
